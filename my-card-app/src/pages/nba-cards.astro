---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const { searchParams } = Astro.url;
const queryFolder = searchParams.get('folder') || ""; 

const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;

// 1. URLからゲームID（10桁の数字）を抽出
const gameIdMatch = queryFolder.match(/\d{10}/);
const gameId = gameIdMatch ? gameIdMatch[0] : "";

// 2. 日付を抽出（6桁または8桁）
const segments = queryFolder.split('/').filter(Boolean);
const dateId = segments[0] || ""; 

let teamsData = [];
let debugLog = "";
let finalPath = "";

try {
  // 3. 日付フォルダの中身をスキャンして、ゲームIDが含まれるフォルダを探す
  const listApi = `https://api.github.com/repos/${GITHUB_REPO}/contents/output/players/${dateId}?t=${Date.now()}`;
  const res = await fetch(listApi, { headers: token ? { "Authorization": `token ${token}` } : {} });
  const items = await res.json();

  if (Array.isArray(items)) {
    // ゲームID（例: 0022500659）が含まれるフォルダを特定
    const realFolder = items.find(item => item.name.includes(gameId) && item.type === 'dir');
    
    if (realFolder) {
      finalPath = realFolder.path;
      const rawBase = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${finalPath}`;

      // 4. そのフォルダ内のPNGファイルを取得
      const filesRes = await fetch(realFolder.url, { headers: token ? { "Authorization": `token ${token}` } : {} });
      const files = await filesRes.json();

      if (Array.isArray(files)) {
        const playerFiles = files.filter(f => f.name.toLowerCase().endsWith('.png'));
        
        // ファイル名が "チーム_背番号_名前.png" であることを前提にチームを分離
        const teamIds = [...new Set(playerFiles.map(f => f.name.split('_')[0]))];

        teamsData = teamIds.map(id => {
          const players = playerFiles
            .filter(f => f.name.startsWith(id + '_'))
            .map(f => {
              const parts = f.name.replace(/\.[^/.]+$/, "").split('_');
              return {
                no: parts[1] || "0",
                name: parts.slice(2).join(' '),
                imagePath: `${rawBase}/${f.name}`
              };
            })
            .sort((a, b) => parseInt(a.no) - parseInt(b.no));
          return { teamName: id, players };
        });
      }
    } else {
      debugLog = `ゲームID [${gameId}] を含むフォルダが ${dateId} 内に見つかりません。`;
    }
  } else {
    debugLog = `日付フォルダ [output/players/${dateId}] が見つかりません。`;
  }
} catch (e) {
  debugLog = `エラー: ${e.message}`;
}

const teamColorMap = {
  ATL: 'bg-[#E03A3E]', BOS: 'bg-[#007A33]', BKN: 'bg-black', CHA: 'bg-[#00788C]',
  CHI: 'bg-[#CE1141]', CLE: 'bg-[#6F263D]', DAL: 'bg-[#0053BC]', DEN: 'bg-[#0E2240]',
  PHI: 'bg-[#006BB6]', WAS: 'bg-[#002B5C]', GSW: 'bg-[#1D428A]', LAL: 'bg-[#552583]'
};
---

<Layout title="NBA CARDS | B-Data Lab">
  <div class="bg-[#0f0f10] min-h-screen text-white font-sans">
    
    {teamsData.length === 0 ? (
      <div class="flex flex-col items-center justify-center min-h-screen">
        <div class="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-sm font-bold tracking-widest opacity-50 uppercase">Loading Game {gameId}...</p>
        <div class="mt-8 p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-[10px] font-mono text-red-400 max-w-xs">
          {debugLog}
        </div>
      </div>
    ) : (
      <div class="max-w-6xl mx-auto px-6 py-12">
        <header class="mb-16">
          <div class="flex justify-between items-center mb-4">
            <button onclick="history.back()" class="text-[10px] font-black tracking-widest bg-white/5 hover:bg-white/10 px-4 py-2 rounded-full transition-all border border-white/5">BACK</button>
            <span class="text-[10px] font-black text-blue-500 tracking-[0.3em] uppercase">NBA Session</span>
          </div>
          <div class="flex items-baseline gap-4">
            <h1 class="text-5xl font-black italic tracking-tighter uppercase">
              {teamsData[0]?.teamName} <span class="text-blue-600 not-italic mx-1 text-2xl">VS</span> {teamsData[1]?.teamName}
            </h1>
          </div>
          <p class="text-[10px] text-white/20 mt-4 font-mono uppercase tracking-widest">ID: {gameId} | Path: {finalPath}</p>
        </header>

        <div class="space-y-24">
          {teamsData.map((team) => (
            <section>
              <div class="flex items-center gap-4 mb-10">
                <div class={`h-10 px-6 ${teamColorMap[team.teamName] || 'bg-gray-800'} flex items-center justify-center rounded-br-2xl rounded-tl-2xl shadow-lg`}>
                   <span class="text-lg font-black italic tracking-tighter">{team.teamName}</span>
                </div>
                <div class="h-[1px] flex-grow bg-white/5"></div>
              </div>

              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 sm:gap-6">
                {team.players.map((p) => (
                  <div class="group relative">
                    <div class="aspect-[3/4] rounded-2xl overflow-hidden bg-[#1a1a1b] border border-white/5 group-hover:border-blue-500/50 transition-all duration-500 shadow-2xl">
                      <img src={p.imagePath} class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-700" loading="lazy" />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                      <div class="absolute bottom-4 left-4 right-4">
                        <div class="text-[10px] font-black text-blue-500 mb-1">#{p.no}</div>
                        <div class="text-sm font-bold truncate uppercase tracking-tight leading-none">{p.name}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          ))}
        </div>
      </div>
    )}
  </div>
</Layout>

<style is:global>
  @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;900&display=swap');
  body { font-family: 'Inter', sans-serif; }
  h1, .font-black { font-family: 'Archivo Black', sans-serif; }
</style>