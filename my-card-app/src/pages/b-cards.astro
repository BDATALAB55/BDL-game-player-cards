---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- ÊâãÂãïÂ§âÊèõËæûÊõ∏ ---
const cityNameMap = {
  "HOKKAIDO": "HOKKAIDO", "LEVANGA": "HOKKAIDO",
  "89ERS": "SENDAI", "SENDAI": "SENDAI",
  "AKITA": "AKITA", "NORTHERNHAPPINETS": "AKITA",
  "IBARAKI": "IBARAKI", "ROBOTS": "IBARAKI",
  "BREX": "UTSUNOMIYA", "UTSUNOMIYA": "UTSUNOMIYA",
  "GUNMA": "GUNMA", "CRANETHUNDERS": "GUNMA",
  "ALPHAS": "KOSHIGAYA", "KOSHIGAYA": "KOSHIGAYA",
  "ALTIRI": "A-CHIBA", "ACHIBA": "A-CHIBA",
  "JETS": "CHIBA-J", "CHIBAJ": "CHIBA-J",
  "ALVARK": "A-TOKYO", "ATOKYO": "A-TOKYO",
  "SUNROCKERS": "SR-SHIBUYA", "SHIBUYA": "SR-SHIBUYA",
  "BRAVETHUNDERS": "KAWASAKI", "KAWASAKI": "KAWASAKI",
  "BCORSAIRS": "YOKOHAMA-BC", "YOKOHAMABC": "YOKOHAMA-BC",
  "GROUSES": "TOYAMA", "TOYAMA": "TOYAMA",
  "NEOPHOENIX": "SAN-EN", "SANEN": "SAN-EN",
  "SEAHORSES": "MIKAWA", "MIKAWA": "MIKAWA",
  "FIGHTINGEAGLES": "FE-NAGOYA", "FENAGOYA": "FE-NAGOYA",
  "DOLPHINS": "NAGOYA-D", "DIAMONDDOLPHINS": "NAGOYA-D", "NAGOYA": "NAGOYA-D",
  "LAKES": "SHIGA", "SHIGA": "SHIGA",
  "HANNARYZ": "KYOTO", "KYOTO": "KYOTO",
  "EVESSA": "OSAKA", "OSAKA": "OSAKA",
  "SUSANOOMAGIC": "SHIMANE", "SHIMANE": "SHIMANE",
  "DRAGONFLIES": "HIROSHIMA", "HIROSHIMA": "HIROSHIMA",
  "BALLOONERS": "SAGA", "SAGA": "SAGA",
  "VELCA": "NAGASAKI", "NAGASAKI": "NAGASAKI",
  "GOLDENKINGS": "RYUKYU", "RYUKYU": "RYUKYU"
};

const folderParam = Astro.url.searchParams.get('folder') || ""; 

// --- „Éë„ÇπËß£Êûê„Å®Ë£úÊ≠£ ---
// folderParam „ÅØ "260103/game_..." „Å®„ÅÑ„ÅÜÂΩ¢Âºè„ÅßÊù•„Çã„Å®ÊÉ≥ÂÆö
const pathSegments = folderParam.split('/');
const datePart = pathSegments[0] || ""; // ‰æã: "260103"
const gameFolderName = pathSegments[1] || ""; // ‰æã: "game_..."

// ÁîªÂÉè16ÊûöÁõÆ„ÅÆÈÄö„Çä„ÄÅBplayers/B1/ „ÅÆ‰∏ã„ÅØ "B1 260103" „Å®„ÅÑ„ÅÜÂΩ¢Âºè
const correctedDateFolder = datePart.startsWith("B1 ") ? datePart : `B1 ${datePart}`;

// --- „ÉÅ„Éº„É†Âêç„ÅÆËß£Êûê ---
const teamParts = gameFolderName.split('_');
let rawAway = "AWAY";
let rawHome = "HOME";
if (teamParts.length >= 4) {
  rawAway = teamParts[2].toUpperCase();
  rawHome = teamParts[3].toUpperCase();
}
const awayName = cityNameMap[rawAway] || rawAway;
const homeName = cityNameMap[rawHome] || rawHome;

// --- GitHub„Éë„ÇπË®≠ÂÆö ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
// „Çπ„Éö„Éº„Çπ„ÇíÂê´„ÇÄ„Åü„ÇÅ„ÄÅ„É™„ÇØ„Ç®„Çπ„ÉàÊôÇ„Å´ÈÅ©Âàá„Å´Âá¶ÁêÜ„Åï„Çå„Çã„Çà„ÅÜÊßãÁØâ
const baseDir = "output/Bplayers/B1";
const fullPath = `${baseDir}/${correctedDateFolder}/${gameFolderName}`;

// APIÁî®ÔºàÊó•Êú¨Ë™û„ÇÑ„Çπ„Éö„Éº„Çπ„Çí„Ç®„É≥„Ç≥„Éº„ÉâÔºâ
const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${encodeURIComponent(fullPath)}`;
// ÁîªÂÉèË°®Á§∫Áî®
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${fullPath}`;

const token = process.env.GITHUB_TOKEN;
let images = [];
let debugInfo = "";

try {
  const res = await fetch(API_URL, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  
  if (!res.ok) {
    debugInfo = `Status ${res.status}: Not Found at [${fullPath}]`;
  } else {
    const data = await res.json();
    if (Array.isArray(data)) {
      images = data
        .filter(file => file.name.toLowerCase().endsWith('.png'))
        .map(file => ({
          path: `${IMAGE_BASE_URL}/${encodeURIComponent(file.name)}`,
          name: file.name
        }));
    }
  }
} catch (e) {
  debugInfo = `Exception: ${e.message}`;
}
---

<Layout title={`${awayName} vs ${homeName}`}>
  <div class="bg-[#1a1a1a] min-h-screen text-white font-avenir">
    <header class="pt-12 pb-6 px-8 text-center">
      <div class="inline-block border-b-2 border-blue-500 pb-2">
        <h1 class="text-xl font-black uppercase tracking-widest leading-relaxed">
          {awayName} <span class="text-gray-500 text-sm mx-2 italic font-medium">vs</span> {homeName}
        </h1>
      </div>
      <p class="text-[10px] text-gray-500 mt-4 tracking-[0.3em] uppercase">Player Stats Cards</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12">
      {images.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {images.map((img) => (
            <div class="group">
              <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900 border border-white/5 transition-all duration-500 hover:scale-[1.02] hover:border-blue-500/30">
                <img 
                  src={img.path} 
                  alt={img.name} 
                  class="w-full h-auto block" 
                  loading="lazy" 
                />
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 bg-gray-800/20 rounded-3xl border border-white/5 mx-4">
          <p class="text-gray-500 font-black text-xs uppercase tracking-widest italic">No player cards found</p>
          <div class="mt-8 text-[10px] text-gray-600 font-mono px-6 leading-relaxed bg-black/30 py-4 rounded-xl inline-block text-left">
            <p class="text-blue-400 mb-1">üîç Debug Path Info:</p>
            <p>Repo: {GITHUB_REPO}</p>
            <p>Path: {fullPath}</p>
            {debugInfo && <p class="text-red-500 mt-2">Error: {debugInfo}</p>}
          </div>
        </div>
      )}
    </main>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50">
      <a href="/b-reports" class="bg-gray-800/90 backdrop-blur-md text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest border border-white/10 shadow-2xl active:scale-95 transition-all hover:bg-white hover:text-black">
        Back to Reports
      </a>
    </div>
  </div>
</Layout>