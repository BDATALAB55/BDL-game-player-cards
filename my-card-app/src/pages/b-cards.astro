---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- 手動変換辞書（b-reportsと同じもの） ---
const cityNameMap = {
  "HOKKAIDO": "HOKKAIDO", "LEVANGA": "HOKKAIDO",
  "89ERS": "SENDAI", "SENDAI": "SENDAI",
  "AKITA": "AKITA", "NORTHERNHAPPINETS": "AKITA",
  "IBARAKI": "IBARAKI", "ROBOTS": "IBARAKI",
  "BREX": "UTSUNOMIYA", "UTSUNOMIYA": "UTSUNOMIYA",
  "CRANETHUNDERS": "GUNMA", "GUNMA": "GUNMA",
  "ALPHAS": "KOSHIGAYA", "KOSHIGAYA": "KOSHIGAYA",
  "ALTIRI": "CHIBA", "ACHIBA": "CHIBA",
  "JETS": "CHIBAJ", "CHIBAJ": "CHIBAJ",
  "ALVARK": "ATOKYO", "ATOKYO": "ATOKYO",
  "SUNROCKERS": "SHIBUYA", "SHIBUYA": "SHIBUYA",
  "BRAVETHUNDERS": "KAWASAKI", "KAWASAKI": "KAWASAKI",
  "BCORSAIRS": "YOKOHAMABC", "YOKOHAMABC": "YOKOHAMABC",
  "GROUSES": "TOYAMA", "TOYAMA": "TOYAMA",
  "NEOPHOENIX": "SANEN", "SANEN": "SANEN",
  "SEAHORSES": "MIKAWA", "MIKAWA": "MIKAWA",
  "FIGHTINGEAGLES": "FENAGOYA", "FENAGOYA": "FENAGOYA",
  "DOLPHINS": "NAGOYAD", "DIAMONDDOLPHINS": "NAGOYAD", "NAGOYA": "NAGOYAD",
  "LAKES": "SHIGA", "SHIGA": "SHIGA",
  "HANNARYZ": "KYOTO", "KYOTO": "KYOTO",
  "EVESSA": "OSAKA", "OSAKA": "OSAKA",
  "SUSANOOMAGIC": "SHIMANE", "SHIMANE": "SHIMANE",
  "DRAGONFLIES": "HIROSHIMA", "HIROSHIMA": "HIROSHIMA",
  "BALLOONERS": "SAGA", "SAGA": "SAGA",
  "VELCA": "NAGASAKI", "NAGASAKI": "NAGASAKI",
  "GOLDENKINGS": "RYUKYU", "RYUKYU": "RYUKYU"
};

const folderParam = Astro.url.searchParams.get('folder') || ""; 
// folderParam は "B1 260103/game_505092_SENDAI_UTSUNOMIYA_20260103" のような形式を想定

// --- チーム名の解析 ---
const parts = folderParam.split('_');
// parts[2] = SENDAI, parts[3] = UTSUNOMIYA を取得
const rawAway = (parts[2] || "AWAY").toUpperCase();
const rawHome = (parts[3] || "HOME").toUpperCase();

const awayName = cityNameMap[rawAway] || rawAway;
const homeName = cityNameMap[rawHome] || rawHome;

// --- 画像取得用設定 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
// 重要：スクリーンショットに基づき、階層を「ゲーム別選手スタッツ」に変更
const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/contents/output/ゲーム別選手スタッツ/${folderParam}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/ゲーム別選手スタッツ/${folderParam}`;

const token = process.env.GITHUB_TOKEN;
let images = [];

try {
  const res = await fetch(API_URL, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  const data = await res.json();
  if (Array.isArray(data)) {
    images = data
      .filter(file => file.name.toLowerCase().endsWith('.png'))
      .map(file => ({
        path: `${IMAGE_BASE_URL}/${file.name}`,
        name: file.name
      }));
  }
} catch (e) {
  console.error("Fetch Error:", e);
}
---

<Layout title={`${awayName} vs ${homeName} - Player Cards`}>
  <div class="bg-[#1a1a1a] min-h-screen text-white font-avenir">
    <header class="pt-12 pb-6 px-8 text-center">
      <div class="inline-block border-b-2 border-blue-500 pb-2">
        <h1 class="text-xl font-black uppercase tracking-widest">
          {awayName} <span class="text-gray-500 text-sm mx-2 italic font-medium">vs</span> {homeName}
        </h1>
      </div>
      <p class="text-[10px] text-gray-500 mt-4 tracking-[0.3em] uppercase">Player Stats Cards</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12">
      {images.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {images.map((img) => (
            <div class="group">
              <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900 border border-white/5 transition-transform duration-500 hover:scale-[1.02]">
                <img 
                  src={img.path} 
                  alt={img.name}
                  class="w-full h-auto block"
                  loading="lazy"
                />
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20">
          <p class="text-gray-600 font-black text-xs uppercase tracking-widest">No player cards found in:</p>
          <p class="text-gray-400 text-[10px] mt-2 opacity-50">{folderParam}</p>
        </div>
      )}
    </main>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50">
      <a href="/b-reports" class="bg-white/10 backdrop-blur-md text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest border border-white/20 hover:bg-white hover:text-black transition-all">
        Back to Reports
      </a>
    </div>
  </div>
</Layout>