---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- 手動変換辞書 ---
const cityNameMap = {
  "HOKKAIDO": "HOKKAIDO", "LEVANGA": "HOKKAIDO",
  "89ERS": "SENDAI", "SENDAI": "SENDAI",
  "AKITA": "AKITA", "NORTHERNHAPPINETS": "AKITA",
  "IBARAKI": "IBARAKI", "ROBOTS": "IBARAKI",
  "BREX": "UTSUNOMIYA", "UTSUNOMIYA": "UTSUNOMIYA",
  "CRANETHUNDERS": "GUNMA", "GUNMA": "GUNMA",
  "ALPHAS": "KOSHIGAYA", "KOSHIGAYA": "KOSHIGAYA",
  "ALTIRI": "A-CHIBA", "ACHIBA": "A-CHIBA",
  "JETS": "CHIBA-J", "CHIBAJ": "CHIBA-J",
  "ALVARK": "A-TOKYO", "ATOKYO": "A-TOKYO",
  "SUNROCKERS": "SR-SHIBUYA", "SHIBUYA": "SR-SHIBUYA",
  "BRAVETHUNDERS": "KAWASAKI", "KAWASAKI": "KAWASAKI",
  "BCORSAIRS": "YOKOHAMA-BC", "YOKOHAMABC": "YOKOHAMA-BC",
  "GROUSES": "TOYAMA", "TOYAMA": "TOYAMA",
  "NEOPHOENIX": "SAN-EN", "SANEN": "SAN-EN",
  "SEAHORSES": "MIKAWA", "MIKAWA": "MIKAWA",
  "FIGHTINGEAGLES": "FE-NAGOYA", "FENAGOYA": "FE-NAGOYA",
  "DOLPHINS": "NAGOYA-D", "DIAMONDDOLPHINS": "NAGOYA-D", "NAGOYA": "NAGOYA-D",
  "LAKES": "SHIGA", "SHIGA": "SHIGA",
  "HANNARYZ": "KYOTO", "KYOTO": "KYOTO",
  "EVESSA": "OSAKA", "OSAKA": "OSAKA",
  "SUSANOOMAGIC": "SHIMANE", "SHIMANE": "SHIMANE",
  "DRAGONFLIES": "HIROSHIMA", "HIROSHIMA": "HIROSHIMA",
  "BALLOONERS": "SAGA", "SAGA": "SAGA",
  "VELCA": "NAGASAKI", "NAGASAKI": "NAGASAKI",
  "GOLDENKINGS": "RYUKYU", "RYUKYU": "RYUKYU"
};

const folderParam = Astro.url.searchParams.get('folder') || ""; 

// --- パスの補正ロジック ---
// スクリーンショットに合わせて、フォルダ名の頭に "B1 " がなければ付与する
let correctedFolder = folderParam;
if (folderParam && !folderParam.startsWith("B1 ")) {
    const parts = folderParam.split('/');
    if (parts.length > 0) {
        parts[0] = "B1 " + parts[part[0].length === 6 ? 0 : 0]; // 日付フォルダを補正
        correctedFolder = parts.join('/');
    }
}

// --- チーム名の解析 ---
const folderNameOnly = folderParam.split('/').pop() || "";
const teamParts = folderNameOnly.split('_');
let rawAway = "AWAY";
let rawHome = "HOME";

if (teamParts.length >= 4) {
  rawAway = teamParts[2].toUpperCase();
  rawHome = teamParts[3].toUpperCase();
}

const awayName = cityNameMap[rawAway] || rawAway;
const homeName = cityNameMap[rawHome] || rawHome;

// --- 画像取得 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
// フォルダ名を「Bplayers」に変更した前提
const baseDir = "output/Bplayers/B1"; 
const fullPath = `${baseDir}/${folderParam}`; // ここを実際の階層に合わせて調整

const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${fullPath}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${fullPath}`;

const token = process.env.GITHUB_TOKEN;
let images = [];
let debugInfo = "";

try {
  const res = await fetch(API_URL, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  
  if (!res.ok) {
    debugInfo = `404 Error: Could not find folder at [${fullPath}]. Please check if the folder name in GitHub matches exactly.`;
  } else {
    const data = await res.json();
    if (Array.isArray(data)) {
      images = data
        .filter(file => file.name.toLowerCase().endsWith('.png'))
        .map(file => ({
          path: `${IMAGE_BASE_URL}/${file.name}`,
          name: file.name
        }));
    }
  }
} catch (e) {
  debugInfo = `Error: ${e.message}`;
}
---

<Layout title={`${awayName} vs ${homeName}`}>
  <div class="bg-[#1a1a1a] min-h-screen text-white font-avenir">
    <header class="pt-12 pb-6 px-8 text-center">
      <div class="inline-block border-b-2 border-blue-500 pb-2">
        <h1 class="text-xl font-black uppercase tracking-widest">
          {awayName} <span class="text-gray-500 text-sm mx-2 italic font-medium">vs</span> {homeName}
        </h1>
      </div>
      <p class="text-[10px] text-gray-500 mt-4 tracking-[0.3em] uppercase">Player Stats Cards</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12">
      {images.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {images.map((img) => (
            <div class="group">
              <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900 border border-white/5 transition-all duration-500 hover:scale-[1.02]">
                <img src={img.path} alt={img.name} class="w-full h-auto block" loading="lazy" />
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 bg-gray-900/50 rounded-3xl border border-white/5 mx-4">
          <p class="text-gray-500 font-black text-xs uppercase tracking-widest">No player cards found</p>
          <div class="mt-6 text-[10px] text-gray-400 font-mono px-10 leading-loose">
            <p class="text-red-500 mb-2">{debugInfo}</p>
            <hr class="border-white/10 my-4" />
            <p>1. GitHubのフォルダ名を「Bplayers」に変えましたか？</p>
            <p>2. その中に「B1」フォルダがありますか？</p>
            <p>3. 階層は [output/Bplayers/B1/日付フォルダ/試合フォルダ] ですか？</p>
          </div>
        </div>
      )}
    </main>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50">
      <a href="/b-reports" class="bg-gray-800 text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest border border-white/10 shadow-2xl active:scale-95">
        Back to Reports
      </a>
    </div>
  </div>
</Layout>