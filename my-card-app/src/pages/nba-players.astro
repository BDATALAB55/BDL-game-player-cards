---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// 1. URLパラメータから選手名を取得
const { searchParams } = Astro.url;
const playerName = searchParams.get('name') || "";

// --- 設定：リポジトリ情報 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;
const githubRawBase = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/players`;
const RECURSIVE_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1&t=${Date.now()}`;

let playerCards = [];
let totalGames = 0;

if (playerName) {
  try {
    // 1回のリクエストで全ディレクトリ構造を取得
    const res = await fetch(RECURSIVE_API, {
      headers: {
        ...(token ? { "Authorization": `token ${token}` } : {}),
        "Accept": "application/vnd.github.v3+json"
      },
      cache: 'no-store'
    });
    const data = await res.json();

    if (data.tree) {
      // 選手名に含まれるスペースをアンダースコアに置換した検索用文字列
      const searchPattern = playerName.replace(/\s+/g, '_').toLowerCase();

      // 該当選手の画像ファイルを一括抽出
      const matchedFiles = data.tree.filter(item => {
        const path = item.path.toLowerCase();
        return (
          path.includes('output/players/') && 
          path.endsWith('.png') && 
          path.includes(searchPattern)
        );
      });

      // 抽出したファイルを整形
      playerCards = matchedFiles.map(file => {
        const parts = file.path.split('/');
        // parts[2] = 日付(YYMMDD), parts[3] = 試合フォルダ, parts[4] = ファイル名
        const dateStr = parts[2] || "";
        return {
          date: dateStr,
          imagePath: `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${file.path}?t=${Date.now()}`
        };
      }).sort((a, b) => b.date.localeCompare(a.date)); // 新しい日付順
    }
    totalGames = playerCards.length;
  } catch (e) {
    console.error("Fetch error:", e);
  }
}
---

<Layout title={`${playerName} - Player Stats`}>
  <div class="min-h-screen bg-[#373A36] text-white font-avenir relative pb-20">
    
    <div class="absolute top-10 left-0 w-full overflow-hidden whitespace-nowrap pointer-events-none opacity-5 select-none z-0">
      <span class="text-[20vw] font-black italic uppercase tracking-tighter">{playerName}</span>
    </div>

    <header class="relative z-10 pt-20 pb-10 text-center">
      <span class="text-blue-500 text-xs font-black tracking-[0.5em] uppercase mb-4 block">NBA Player</span>
      <h1 class="text-6xl md:text-8xl font-black italic uppercase leading-none tracking-tighter">
        {playerName}
      </h1>
    </header>

    <main class="max-w-7xl mx-auto px-6 relative z-10">
      
      <div class="flex justify-between items-end mb-12">
        <div>
          <h2 class="text-2xl font-black italic uppercase tracking-tight italic">Performance Cards</h2>
          <p class="text-[10px] text-white/40 font-bold tracking-widest uppercase">Personal Game Stats</p>
        </div>
        <div class="text-right">
          <span class="text-6xl font-black italic leading-none">{totalGames}</span>
          <p class="text-[10px] text-white/40 font-bold tracking-[0.3em] uppercase">Games</p>
        </div>
      </div>

      {playerCards.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
          {playerCards.map((card) => (
            <div class="group">
              <div class="mb-3 flex items-center gap-2">
                <span class="h-[1px] w-4 bg-blue-500"></span>
                <span class="text-[11px] font-black text-white/60 tracking-widest">
                  20{card.date.substring(0,2)}.{card.date.substring(2,4)}.{card.date.substring(4,6)}
                </span>
              </div>
              <div class="relative rounded-xl overflow-hidden shadow-2xl transition-all duration-500 group-hover:scale-[1.03] group-hover:shadow-blue-500/20 border border-white/5">
                <img src={card.imagePath} alt={playerName} class="w-full h-auto block" loading="lazy" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="py-32 rounded-3xl border-2 border-dashed border-white/5 flex flex-col items-center justify-center bg-black/10 backdrop-blur-sm">
          <p class="text-white/20 font-black italic uppercase tracking-[0.3em] text-sm">No data found for this player</p>
        </div>
      )}

      <div class="mt-32 pt-20 border-t border-white/5">
         <p class="text-center text-[10px] font-black tracking-[0.5em] text-white/20 uppercase mb-10">Active Calendar</p>
      </div>
    </main>

    <nav class="fixed bottom-8 left-0 w-full px-8 flex justify-between items-center z-50">
      <button onclick="history.back()" class="bg-white/10 backdrop-blur-md hover:bg-white/20 text-white px-6 py-3 rounded-xl border border-white/10 transition-all active:scale-95 group">
        <span class="text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back
        </span>
      </button>

      <a href="/nba-home" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl shadow-xl shadow-blue-600/20 transition-all active:scale-95">
        <span class="text-[10px] font-black uppercase tracking-[0.2em]">NBA Home</span>
      </a>
    </nav>

  </div>
</Layout>

<style is:global>
  @import url('https://fonts.cdnfonts.com/css/avenir-next-lt-pro');
  :root { font-family: 'Avenir Next LT Pro', sans-serif; }
  .font-avenir { font-family: 'Avenir Next LT Pro', sans-serif; }
</style>