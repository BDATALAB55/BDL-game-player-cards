---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// 1. URLパラメータからフォルダ名を取得 (例: 241022/NBA_Cards_0022400062_20241022)
const { searchParams } = Astro.url;
const folderPath = searchParams.get('folder') || "";

// --- 設定：リポジトリ情報 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;
const githubRawBase = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/players`;

let reportImage = "";
let playerCardImages = [];
let gameDate = "";
let gameMatchup = "";

if (folderPath) {
  try {
    // フォルダ内のファイルを一括取得するためのAPI
    const apiUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/output/players/${folderPath}?t=${Date.now()}`;
    
    const res = await fetch(apiUrl, {
      headers: {
        ...(token ? { "Authorization": `token ${token}` } : {}),
        "Accept": "application/vnd.github.v3+json"
      },
      cache: 'no-store'
    });
    
    const files = await res.json();

    if (Array.isArray(files)) {
      // 1. レポート画像の抽出 (Reportが含まれるファイル)
      const reportFile = files.find(f => f.name.toLowerCase().includes('report') && f.name.endsWith('.png'));
      if (reportFile) {
        reportImage = `${reportFile.download_url}?t=${Date.now()}`;
        
        // ファイル名から日付と対戦カードを推測 (NBA_Report_20241022_0022400062_NYK_BOS.png)
        const nameParts = reportFile.name.replace('.png', '').split('_');
        gameDate = nameParts[2] || "";
        const teamA = nameParts[nameParts.length - 2] || "";
        const teamB = nameParts[nameParts.length - 1] || "";
        gameMatchup = teamA && teamB ? `${teamA} vs ${teamB}` : "Game Stats";
      }

      // 2. 選手スタッツ画像の抽出 (Report以外、かつ.png)
      playerCardImages = files
        .filter(f => !f.name.toLowerCase().includes('report') && f.name.endsWith('.png'))
        .map(f => ({
          name: f.name.split('_')[0], // 選手名
          url: `${f.download_url}?t=${Date.now()}`
        }));
    }
  } catch (e) {
    console.error("Fetch error:", e);
  }
}

// チームボタン用のリスト (以前の見た目を維持)
const teams = [
  { id: 'ATL', color: 'bg-[#E03A3E]' }, { id: 'BOS', color: 'bg-[#007A33]' },
  { id: 'BKN', color: 'bg-black border border-white/20' }, { id: 'CHA', color: 'bg-[#00788C]' },
  { id: 'CHI', color: 'bg-[#CE1141]' }, { id: 'CLE', color: 'bg-[#6F263D]' },
  { id: 'DAL', color: 'bg-[#0053BC]' }, { id: 'DEN', color: 'bg-[#0E2240]' },
  { id: 'DET', color: 'bg-[#1D428A]' }, { id: 'GSW', color: 'bg-[#006BB6]' },
  { id: 'HOU', color: 'bg-[#CE1141]' }, { id: 'IND', color: 'bg-[#002D62]' },
  { id: 'LAC', color: 'bg-[#12173F]' }, { id: 'LAL', color: 'bg-[#552583]' },
  { id: 'MEM', color: 'bg-[#5D76A9]' }, { id: 'MIA', color: 'bg-[#98002E]' },
  { id: 'MIL', color: 'bg-[#00471B]' }, { id: 'MIN', color: 'bg-[#0C2340]' },
  { id: 'NOP', color: 'bg-[#0C2340]' }, { id: 'NYK', color: 'bg-[#F58426]' },
  { id: 'OKC', color: 'bg-[#007AC1]' }, { id: 'ORL', color: 'bg-[#0077C0]' },
  { id: 'PHI', color: 'bg-[#006BB6]' }, { id: 'PHX', color: 'bg-[#1D1160]' },
  { id: 'POR', color: 'bg-[#E03A3E]' }, { id: 'SAC', color: 'bg-[#5A2D81]' },
  { id: 'SAS', color: 'bg-black border border-white/20' }, { id: 'TOR', color: 'bg-[#CE1141]' },
  { id: 'UTA', color: 'bg-[#002B5C]' }, { id: 'WAS', color: 'bg-[#002B5C]' },
];
---

<Layout title="Game Cards | B-Data Lab">
  <main class="bg-[#373A36] min-h-screen text-white font-avenir pb-32">
    
    <header class="pt-20 pb-12 text-center px-6 border-b border-white/5 relative overflow-hidden">
      <div class="absolute top-0 left-1/2 -translate-x-1/2 text-[15vw] font-black opacity-[0.03] select-none italic uppercase tracking-tighter whitespace-nowrap leading-none">
        {gameMatchup}
      </div>
      <div class="relative z-10">
        <p class="text-blue-500 font-black tracking-[0.5em] uppercase text-[10px] mb-4 italic">Game Detail Report</p>
        <h1 class="text-5xl md:text-7xl font-black tracking-tighter italic uppercase leading-tight mb-2">{gameMatchup}</h1>
        <p class="text-white/40 font-bold tracking-widest text-sm uppercase italic">20{folderPath.substring(0,2)}.{folderPath.substring(2,4)}.{folderPath.substring(4,6)}</p>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 mt-20">
      
      <section class="mb-32 max-w-4xl mx-auto">
        <div class="flex items-center gap-4 mb-10 justify-center">
          <span class="h-[1px] w-12 bg-white/20"></span>
          <h2 class="text-xs font-black tracking-[0.6em] uppercase text-white/40 italic">Main Report</h2>
          <span class="h-[1px] w-12 bg-white/20"></span>
        </div>
        {reportImage ? (
          <div class="rounded-3xl overflow-hidden shadow-[0_40px_100px_rgba(0,0,0,0.6)] border border-white/10 group bg-black/40 relative">
             <img src={reportImage} alt="Game Report" class="w-full h-auto block" />
             <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none"></div>
          </div>
        ) : (
          <div class="aspect-[3/4.2] rounded-3xl border-2 border-dashed border-white/5 flex items-center justify-center bg-black/10">
            <p class="text-white/20 font-black italic uppercase tracking-widest">Loading Report...</p>
          </div>
        )}
      </section>

      <section class="mb-40">
        <div class="flex justify-between items-end mb-16 px-4">
          <div>
            <h3 class="text-3xl font-black italic uppercase tracking-tight">Player Performance</h3>
            <p class="text-[10px] text-white/40 font-bold tracking-[0.4em] uppercase mt-2">Individual Stats Archive</p>
          </div>
          <div class="text-right">
            <span class="text-6xl font-black italic leading-none opacity-20">{playerCardImages.length}</span>
            <p class="text-[10px] text-white/40 font-bold tracking-widest uppercase">Cards</p>
          </div>
        </div>

        {playerCardImages.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10">
            {playerCardImages.map((card) => (
              <div class="group">
                <div class="mb-4 flex items-center gap-3">
                  <span class="h-4 w-[2px] bg-blue-500"></span>
                  <span class="text-[11px] font-black tracking-[0.2em] uppercase text-white/60">{card.name}</span>
                </div>
                <div class="relative rounded-2xl overflow-hidden shadow-2xl transition-all duration-500 group-hover:scale-[1.05] group-hover:shadow-blue-500/20 border border-white/5 bg-black/40">
                  <img src={card.url} alt={card.name} class="w-full h-auto block" loading="lazy" />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="py-32 rounded-3xl border-2 border-dashed border-white/5 flex flex-col items-center justify-center bg-black/10 backdrop-blur-sm">
            <p class="text-white/20 font-black italic uppercase tracking-[0.3em] text-sm">Scanning for player stats...</p>
          </div>
        )}
      </section>

      <section class="border-t border-white/5 pt-32 pb-20">
        <h3 class="text-center text-[10px] font-black tracking-[0.6em] uppercase mb-16 text-white/20 italic">Switch Team</h3>
        <div class="grid grid-cols-5 md:grid-cols-10 gap-4">
          {teams.map((team) => (
            <a href={`/nba-team?team=${team.id}`} class="group">
              <div class={`${team.color} aspect-square rounded-xl flex items-center justify-center transition-all duration-300 group-hover:scale-110 group-active:scale-95 shadow-lg`}>
                <span class="text-[11px] font-black italic tracking-tighter text-white">{team.id}</span>
              </div>
            </a>
          ))}
        </div>
      </section>
    </div>

    <nav class="fixed bottom-8 left-0 w-full px-8 flex justify-between items-center z-50">
      <button onclick="history.back()" class="bg-white/10 backdrop-blur-md hover:bg-white/20 text-white px-8 py-4 rounded-2xl border border-white/10 transition-all active:scale-95 group shadow-2xl">
        <span class="text-[10px] font-black uppercase tracking-[0.3em] flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
          Back
        </span>
      </button>

      <a href="/nba-home" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-2xl shadow-xl shadow-blue-600/20 transition-all active:scale-95 border border-blue-400/20">
        <span class="text-[10px] font-black uppercase tracking-[0.3em]">NBA Home</span>
      </a>
    </nav>

  </main>
</Layout>

<style is:global>
  @import url('https://fonts.cdnfonts.com/css/avenir-next-lt-pro');
  :root { font-family: 'Avenir Next LT Pro', sans-serif; }
  .font-avenir { font-family: 'Avenir Next LT Pro', sans-serif; }
</style>