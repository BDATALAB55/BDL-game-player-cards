---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// 1. URLから ?team= の値を取得
const { searchParams } = Astro.url;
const teamId = searchParams.get('team') || "GSW";

// --- 設定：リポジトリ情報 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const RECURSIVE_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1&t=${Date.now()}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/reports/NBA`;

const token = process.env.GITHUB_TOKEN;

let teamReports = [];

try {
  const res = await fetch(RECURSIVE_API, {
    headers: {
      ...(token ? { "Authorization": `token ${token}` } : {}),
      "Accept": "application/vnd.github.v3+json"
    },
    cache: 'no-store'
  });
  const data = await res.json();

  if (data.tree) {
    const allFiles = data.tree.filter(item => 
      item.path.includes('output/reports/NBA/') && 
      item.path.toLowerCase().endsWith('.png')
    );

    allFiles.forEach(file => {
      const pathParts = file.path.split('/');
      const nbaIndex = pathParts.indexOf('NBA');
      if (nbaIndex === -1 || pathParts.length <= nbaIndex + 2) return;

      const folderName = pathParts[nbaIndex + 1]; 
      const fileName = pathParts[nbaIndex + 2];   

      if (!/^\d+$/.test(folderName)) return;

      const nameParts = fileName.replace('.png', '').split('_');
      // インデックスを修正: [2]=Date, [3]=GameID, [4]=Away, [5]=Home
      const fullDate = nameParts[2] || ""; 
      const gameId = nameParts[3] || "";
      const teamA = nameParts[nameParts.length - 2] || "";
      const teamB = nameParts[nameParts.length - 1] || "";

      // 指定されたチームが含まれる試合のみ抽出
      if (teamA === teamId || teamB === teamId) {
        const cardFolderName = `NBA_Cards_${gameId}_${fullDate}`;
        
        teamReports.push({
          id: folderName,
          date: `20${folderName.substring(0,2)}.${folderName.substring(2,4)}.${folderName.substring(4,6)}`,
          path: `${IMAGE_BASE_URL}/${folderName}/${fileName}?t=${Date.now()}`,
          away: teamA,
          home: teamB,
          link: `/nba-cards?folder=${folderName}/${cardFolderName}`
        });
      }
    });

    // 新しい順にソート
    teamReports.sort((a, b) => b.id.localeCompare(a.id));
  }
} catch (e) {
  console.error("Fetch Error:", e);
}

const teamColorMap = {
  ATL: 'bg-[#E03A3E]', BOS: 'bg-[#007A33]', BKN: 'bg-black border border-white/20',
  CHA: 'bg-[#00788C]', CHI: 'bg-[#CE1141]', CLE: 'bg-[#6F263D]',
  DAL: 'bg-[#0053BC]', DEN: 'bg-[#0E2240]', DET: 'bg-[#1D428A]',
  GSW: 'bg-[#006BB6]', HOU: 'bg-[#CE1141]', IND: 'bg-[#002D62]',
  LAC: 'bg-[#12173F]', LAL: 'bg-[#552583]', MEM: 'bg-[#5D76A9]',
  MIA: 'bg-[#98002E]', MIL: 'bg-[#00471B]', MIN: 'bg-[#0C2340]',
  NOP: 'bg-[#0C2340]', NYK: 'bg-[#F58426]', OKC: 'bg-[#007AC1]',
  ORL: 'bg-[#0077C0]', PHI: 'bg-[#006BB6]', PHX: 'bg-[#1D1160]',
  POR: 'bg-[#E03A3E]', SAC: 'bg-[#5A2D81]', SAS: 'bg-black border border-white/20',
  TOR: 'bg-[#CE1141]', UTA: 'bg-[#002B5C]', WAS: 'bg-[#002B5C]',
};
const currentTeamColor = teamColorMap[teamId] || 'bg-gray-700';
---

<Layout title={`${teamId} Reports`}>
  <div class="bg-[#373A36] min-h-screen text-white font-avenir pb-32">
    
    <header class="pt-20 pb-12 px-8 border-b border-white/5 relative overflow-hidden">
      <div class="absolute top-4 left-8 text-[120px] font-black opacity-[0.03] select-none italic tracking-tighter z-0 uppercase">
        {teamId}
      </div>
      <div class="relative z-10">
        <div class="flex items-center gap-4 mb-4">
          <div class={`w-12 h-1.5 ${currentTeamColor} rounded-full`}></div>
          <span class="text-blue-500 font-black tracking-[0.4em] uppercase text-[10px]">Team Archive</span>
        </div>
        <h1 class="text-7xl font-black italic uppercase tracking-tighter leading-none">{teamId}</h1>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-8 mt-16">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-10 gap-y-20">
        {teamReports.length > 0 ? teamReports.map((report) => (
          <div class="group">
            <div class="flex items-center justify-between mb-4 px-1">
              <span class="text-[11px] font-black tracking-[0.2em] text-white/40 uppercase">{report.date}</span>
              <div class="h-[1px] flex-grow mx-4 bg-white/5"></div>
            </div>

            <a href={report.link} class="block mb-8 relative">
              <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 aspect-[3/4.2] relative transition-all duration-500 group-hover:scale-[1.02] group-hover:shadow-blue-500/10">
                <img src={report.path} alt="Team Report" class="w-full h-full object-cover" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
              </div>
            </a>

            <div class="flex flex-col items-center">
              <a href={report.link} class="inline-flex items-center gap-3 px-6 py-2.5 rounded-full bg-black/40 border-2 border-transparent bg-clip-padding relative hover:scale-110 transition-transform group/btn overflow-hidden">
                <div class="absolute inset-0 p-[2px] rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-red-500 -z-10"></div>
                <span class="text-[12px] font-black tracking-[0.2em] uppercase text-white">
                  {report.away} <span class="text-[9px] font-medium lowercase mx-1 text-white/50 italic px-1">vs</span> {report.home}
                </span>
              </a>
            </div>
          </div>
        )) : (
          <div class="col-span-full py-40 text-center border-2 border-dashed border-white/5 rounded-3xl">
             <p class="text-white/20 font-black italic uppercase tracking-[0.3em] text-sm">No report found for this franchise</p>
          </div>
        )}
      </div>
    </main>

    <div class="fixed bottom-10 right-10 z-40">
      <a href="/nba-home" class="bg-gray-800 text-white px-10 py-4 rounded-full font-black text-[11px] uppercase tracking-[0.3em] shadow-2xl hover:bg-gray-700 active:scale-95 transition-all border border-white/10 block">
        Back to Home
      </a>
    </div>
  </div>
</Layout>

<style is:global>
  :root { font-family: "Avenir Next", sans-serif; }
</style>