---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- 手動変換辞書 ---
const cityNameMap = {
  "HOKKAIDO": "HOKKAIDO", "LEVANGA": "HOKKAIDO",
  "89ERS": "SENDAI", "SENDAI": "SENDAI",
  "AKITA": "AKITA", "NORTHERNHAPPINETS": "AKITA",
  "IBARAKI": "IBARAKI", "ROBOTS": "IBARAKI",
  "BREX": "UTSUNOMIYA", "UTSUNOMIYA": "UTSUNOMIYA",
  "CRANETHUNDERS": "GUNMA", "GUNMA": "GUNMA",
  "ALPHAS": "KOSHIGAYA", "KOSHIGAYA": "KOSHIGAYA",
  "ALTIRI": "A-CHIBA", "ACHIBA": "CHIBA",
  "JETS": "CHIBA-J", "CHIBAJ": "CHIBAJ",
  "ALVARK": "A-TOKYO", "ATOKYO": "ATOKYO",
  "SUNROCKERS": "SR-SHIBUYA", "SHIBUYA": "SHIBUYA",
  "BRAVETHUNDERS": "KAWASAKI", "KAWASAKI": "KAWASAKI",
  "BCORSAIRS": "YOKOHAMA-BC", "YOKOHAMABC": "YOKOHAMABC",
  "GROUSES": "TOYAMA", "TOYAMA": "TOYAMA",
  "NEOPHOENIX": "SAN-EN", "SANEN": "SANEN",
  "SEAHORSES": "MIKAWA", "MIKAWA": "MIKAWA",
  "FIGHTINGEAGLES": "FE-NAGOYA", "FENAGOYA": "FENAGOYA",
  "DOLPHINS": "NAGOYA-D", "DIAMONDDOLPHINS": "NAGOYAD", "NAGOYA": "NAGOYAD",
  "LAKES": "SHIGA", "SHIGA": "SHIGA",
  "HANNARYZ": "KYOTO", "KYOTO": "KYOTO",
  "EVESSA": "OSAKA", "OSAKA": "OSAKA",
  "SUSANOOMAGIC": "SHIMANE", "SHIMANE": "SHIMANE",
  "DRAGONFLIES": "HIROSHIMA", "HIROSHIMA": "HIROSHIMA",
  "BALLOONERS": "SAGA", "SAGA": "SAGA",
  "VELCA": "NAGASAKI", "NAGASAKI": "NAGASAKI",
  "GOLDENKINGS": "RYUKYU", "RYUKYU": "RYUKYU"
};

const folderParam = Astro.url.searchParams.get('folder') || ""; 

// --- チーム名の解析ロジックを強化 ---
// URLの末尾（フォルダ名部分）だけを見るように修正
const folderNameOnly = folderParam.split('/').pop() || "";
const parts = folderNameOnly.split('_');

let rawAway = "AWAY";
let rawHome = "HOME";

// game_id_AWAY_HOME_date の形式を想定
if (parts.length >= 4) {
  rawAway = parts[2].toUpperCase();
  rawHome = parts[3].toUpperCase();
}

const awayName = cityNameMap[rawAway] || rawAway;
const homeName = cityNameMap[rawHome] || rawHome;

// --- 画像取得 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
// 日本語が含まれるため encodeURIComponent を使用
const baseDir = "output/ゲーム別選手スタッツ";
const fullPath = `${baseDir}/${folderParam}`;
const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${encodeURIComponent(fullPath)}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${fullPath}`;

const token = process.env.GITHUB_TOKEN;
let images = [];
let debugInfo = "";

try {
  const res = await fetch(API_URL, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  
  if (!res.ok) {
    debugInfo = `API Error: ${res.status} ${res.statusText}`;
  } else {
    const data = await res.json();
    if (Array.isArray(data)) {
      images = data
        .filter(file => file.name.toLowerCase().endsWith('.png'))
        .map(file => ({
          path: `${IMAGE_BASE_URL}/${file.name}`,
          name: file.name
        }));
    }
  }
} catch (e) {
  debugInfo = `Fetch Exception: ${e.message}`;
}
---

<Layout title={`${awayName} vs ${homeName} - Player Cards`}>
  <div class="bg-[#1a1a1a] min-h-screen text-white font-avenir">
    <header class="pt-12 pb-6 px-8 text-center">
      <div class="inline-block border-b-2 border-blue-500 pb-2">
        <h1 class="text-xl font-black uppercase tracking-widest">
          {awayName} <span class="text-gray-500 text-sm mx-2 italic font-medium">vs</span> {homeName}
        </h1>
      </div>
      <p class="text-[10px] text-gray-500 mt-4 tracking-[0.3em] uppercase">Player Stats Cards</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-12">
      {images.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {images.map((img) => (
            <div class="group">
              <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900 border border-white/5 transition-all duration-500 hover:scale-[1.02] hover:border-blue-500/30">
                <img 
                  src={img.path} 
                  alt={img.name}
                  class="w-full h-auto block"
                  loading="lazy"
                  onerror="this.style.display='none'; console.error('Image load failed:', this.src);"
                />
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 bg-gray-900/50 rounded-3xl border border-white/5 mx-4">
          <p class="text-gray-500 font-black text-xs uppercase tracking-widest">No player cards found</p>
          <div class="mt-6 text-[9px] text-gray-600 font-mono space-y-1">
            <p>Target Folder: {folderParam}</p>
            {debugInfo && <p class="text-red-900">{debugInfo}</p>}
          </div>
        </div>
      )}
    </main>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50">
      <a href="/b-reports" class="bg-gray-800/80 backdrop-blur-md text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest border border-white/10 hover:bg-white hover:text-black transition-all shadow-2xl active:scale-95">
        Back to Reports
      </a>
    </div>
  </div>
</Layout>