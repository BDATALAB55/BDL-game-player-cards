---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- 1. URLパラメータ取得 ---
const folderParam = Astro.url.searchParams.get('folder') || ""; 

// --- 2. フォルダ名の解析と補正 ---
// 期待される入力: "260104/20260104_505093_89ERS_BREX"
const segments = folderParam.split('/');
const datePart = segments[0] || ""; // "260104"
const rawMatchDir = segments[1] || ""; // "20260104_505093_89ERS_BREX"

// GitHub上の実際の「日付フォルダ」名は "B1 260104"
const correctedDateFolder = `B1 ${datePart}`;

// --- 重要：試合フォルダ名のマッチングロジック ---
// 入力が "20260104_505093..." でも GitHub上の "game_505093..." を見つけられるようにする
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;
const baseDir = `output/Bplayers/B1/${correctedDateFolder}`;

let finalGameDir = rawMatchDir; // デフォルト
let images = [];
let debugInfo = "";

try {
  // まず日付フォルダの中身を一覧取得して、正しいフォルダ名を探す
  const listRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${baseDir}`, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  const items = await listRes.json();

  if (Array.isArray(items)) {
    // フォルダ名に含まれる「試合ID（505093等）」で検索
    const gameIdMatch = rawMatchDir.match(/\d{6}/); // 6桁のIDを探す
    const gameId = gameIdMatch ? gameIdMatch[0] : "";
    
    const matchedFolder = items.find(item => item.type === 'dir' && item.name.includes(gameId));
    
    if (matchedFolder) {
      finalGameDir = matchedFolder.name; // ここで "game_505093..." がセットされる
    } else {
      debugInfo = `Game ID ${gameId} not found in ${baseDir}`;
    }
  }

  // --- 3. 正しいパスで画像を取得 ---
  const fullPath = `${baseDir}/${finalGameDir}`;
  const apiURL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${fullPath}`;
  const rawBaseURL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${fullPath}`;

  const imgRes = await fetch(apiURL, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  const files = await imgRes.json();

  if (Array.isArray(files)) {
    images = files
      .filter(f => f.name.toLowerCase().endsWith('.png'))
      .map(f => ({
        path: `${rawBaseURL}/${f.name}`,
        name: f.name
      }));
  }
} catch (e) {
  debugInfo = `Fetch Error: ${e.message}`;
}

// チーム名の表示用
const teamNames = finalGameDir.split('_');
const awayName = teamNames[2] || "AWAY";
const homeName = teamNames[3] || "HOME";
---

<Layout title={`${awayName} vs ${homeName}`}>
  <div class="bg-[#1a1a1a] min-h-screen text-white font-avenir pb-20">
    <header class="pt-12 pb-6 px-8 text-center border-b border-white/5">
      <h1 class="text-2xl font-black uppercase tracking-widest">
        {awayName} <span class="text-gray-600 text-sm mx-2 italic font-medium">vs</span> {homeName}
      </h1>
      <p class="text-[10px] text-gray-500 mt-4 tracking-[0.4em] uppercase">Player Statistics Cards</p>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-12">
      {images.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {images.map((img) => (
            <div class="rounded-2xl overflow-hidden shadow-2xl bg-gray-900 border border-white/5">
              <img src={img.path} alt={img.name} class="w-full h-auto block" loading="lazy" />
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 bg-black/20 rounded-3xl border border-white/5">
          <p class="text-gray-500 text-xs font-bold uppercase tracking-widest">No player cards found</p>
          <div class="mt-6 text-[10px] text-gray-600 font-mono inline-block text-left bg-black/40 p-4 rounded-lg">
             <p>Requested: {folderParam}</p>
             <p>Corrected Date Dir: {correctedDateFolder}</p>
             <p>Final Game Dir: {finalGameDir}</p>
             {debugInfo && <p class="text-red-900 mt-2">{debugInfo}</p>}
          </div>
        </div>
      )}
    </main>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50">
      <a href="/b-reports" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl transition-all active:scale-95">
        Back to Reports
      </a>
    </div>
  </div>
</Layout>