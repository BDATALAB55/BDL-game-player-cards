---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// 1. URLパラメータから選手名を取得
const { searchParams } = Astro.url;
const playerName = searchParams.get('name') || "";

// --- 設定：リポジトリ情報 ---
const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;
const RECURSIVE_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1&t=${Date.now()}`;

let playerCards = [];
let totalGames = 0;

if (playerName) {
  try {
    const res = await fetch(RECURSIVE_API, {
      headers: {
        ...(token ? { "Authorization": `token ${token}` } : {}),
        "Accept": "application/vnd.github.v3+json"
      },
      cache: 'no-store'
    });
    const data = await res.json();

    if (data.tree) {
      const searchPattern = playerName.replace(/\s+/g, '_').toLowerCase();
      const matchedFiles = data.tree.filter(item => {
        const path = item.path.toLowerCase();
        return (
          path.includes('output/players/') && 
          path.endsWith('.png') && 
          path.includes(searchPattern)
        );
      });

      playerCards = matchedFiles.map(file => {
        const parts = file.path.split('/');
        const dateStr = parts[2] || "";
        return {
          date: dateStr,
          imagePath: `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${file.path}?t=${Date.now()}`
        };
      }).sort((a, b) => b.date.localeCompare(a.date));
    }
    totalGames = playerCards.length;
  } catch (e) {
    console.error("Fetch error:", e);
  }
}
---

<Layout title={`${playerName} - BDATALAB`}>
  <div class="min-h-screen bg-[#373A36] text-white font-avenir relative pb-40">
    
    <header class="max-w-7xl mx-auto px-8 pt-16 pb-8 flex justify-between items-start border-b border-white/20">
      <div>
        <h1 class="text-7xl font-black uppercase tracking-tighter leading-none">{playerName}</h1>
      </div>
      <div class="flex flex-col items-end gap-2">
        <span class="text-2xl font-black tracking-widest uppercase">BDATALAB</span>
        <div class="flex items-center gap-3 opacity-60">
           <div class="flex items-center gap-1.5 bg-white/10 px-2 py-1 rounded-md">
             <span class="text-[10px] font-black italic">X</span><span class="text-[10px] lowercase opacity-50">x</span>
           </div>
           <span class="text-white/20">|</span>
           <div class="flex items-center gap-1.5 bg-white/10 px-2 py-1 rounded-md">
             <span class="text-[10px] font-black italic">n</span><span class="text-[10px] lowercase opacity-50">note</span>
           </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-8 mt-12">
      <div class="flex justify-between items-baseline mb-10">
        <h2 class="text-3xl font-black uppercase tracking-tight">BOX SCORE</h2>
        <div class="text-right flex flex-col items-end">
          <span class="text-6xl font-black text-white/20 leading-none">{totalGames}</span>
          <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/40">GAMES</span>
        </div>
      </div>

      {playerCards.length > 0 ? (
        <div class="flex overflow-x-auto gap-6 no-scrollbar pb-10 snap-x">
          {playerCards.map((card) => (
            <div class="flex-none w-[280px] snap-start">
              <div class="mb-3 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                <span class="text-[14px] font-black text-white/80">
                  20{card.date.substring(0,2)}.{card.date.substring(2,4)}.{card.date.substring(4,6)}
                </span>
              </div>
              <div class="rounded-lg overflow-hidden border border-white/5 bg-black/40 shadow-2xl transition-transform hover:scale-[1.02]">
                <img src={card.imagePath} alt={playerName} class="w-full h-auto block" loading="lazy" />
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="py-20 rounded-2xl border border-dashed border-white/10 flex items-center justify-center bg-black/5">
          <p class="text-white/20 font-black uppercase tracking-widest text-xs">No game data found</p>
        </div>
      )}

      <div class="mt-32 flex flex-col items-center">
        <p class="text-[10px] font-black tracking-[0.4em] text-white/20 uppercase mb-8">GAME CALENDAR</p>
        <div class="bg-black/20 backdrop-blur-md p-8 rounded-[40px] border border-white/5 w-full max-w-sm">
            <div class="flex justify-between items-center mb-8">
                <button class="text-white/20 text-xl">←</button>
                <span class="text-sm font-black uppercase tracking-widest">JANUARY 2026</span>
                <button class="text-white/20 text-xl">→</button>
            </div>
            <div class="grid grid-cols-7 gap-y-4 text-center">
                {['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d => (
                    <span class="text-[8px] font-black text-white/20">{d}</span>
                ))}
                {/* ダミーカレンダー：特定の日付だけハイライト */}
                {Array.from({length: 31}, (_, i) => i + 1).map(day => {
                   const isGameDay = [3, 4, 24, 25, 28].includes(day);
                   return (
                    <div class="flex justify-center items-center h-8">
                        <span class={`text-[10px] font-bold ${isGameDay ? 'bg-blue-600 w-7 h-7 flex items-center justify-center rounded-full text-white shadow-lg shadow-blue-600/40' : 'text-white/20'}`}>
                            {day}
                        </span>
                    </div>
                   )
                })}
            </div>
        </div>
      </div>
    </main>

    <div class="fixed bottom-8 left-8 z-50">
        <button onclick="history.back()" class="bg-white/10 backdrop-blur-md text-white px-6 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl active:scale-95 border border-white/10 flex items-center gap-2 group">
            <span class="opacity-40 group-hover:opacity-100">←</span> BACK
        </button>
    </div>
    <div class="fixed bottom-8 right-8 z-50">
      <a href="/nba-home" class="bg-[#1D2B3D] backdrop-blur-md text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl active:scale-95 border border-white/10 block">
        B1 HOME
      </a>
    </div>

  </div>
</Layout>

<style is:global>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .font-avenir { font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif; }
</style>