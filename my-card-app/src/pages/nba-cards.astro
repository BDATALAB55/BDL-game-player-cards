---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const { searchParams } = Astro.url;
const queryFolder = searchParams.get('folder') || ""; 

const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;

// パスの徹底解析
const segments = queryFolder.split('/').filter(Boolean);

// 【重要】segments[0]が日付（例: 251202）、segments[1]がフォルダ名（例: NBA_Cards_...）
// もし segments が1つしかない場合は、URLが不完全です。
let datePart = segments[0] || "";
let folderPart = segments[1] || "";

// もし folderPart が空で、datePartの中に "NBA_Cards" が含まれている場合の救済処置
if (!folderPart && datePart.includes('NBA_Cards')) {
    // フォルダ名から日付（末尾8桁など）を推測するか、
    // 前の階層から日付を特定する必要がありますが、ここでは一旦手動解析を試みます
    folderPart = datePart;
    // フォルダ名 "NBA_Cards_CHA_0022500657_20251202" の末尾から日付を抽出
    const dateMatch = folderPart.match(/(\d{8})$/);
    if (dateMatch) {
        const fullDate = dateMatch[1]; // 20251202
        datePart = fullDate.substring(2); // 251202
    }
}

const targetPath = `output/players/${datePart}/${folderPart}`;
const rawBase = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${targetPath}`;

let teamsData = [];
let debugInfo = "";

try {
  // キャッシュを避けるためにタイムスタンプを付与
  const apiURL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${targetPath}?t=${Date.now()}`;
  const res = await fetch(apiURL, {
    headers: token ? { "Authorization": `token ${token}` } : {}
  });
  const files = await res.json();

  if (Array.isArray(files)) {
    const playerFiles = files.filter(f => f.name.toLowerCase().endsWith('.png'));
    const teamIds = [...new Set(playerFiles.map(f => f.name.split('_')[0]))];

    teamsData = teamIds.map(id => {
      const players = playerFiles
        .filter(f => f.name.startsWith(id + '_'))
        .map(f => {
          const parts = f.name.replace(/\.[^/.]+$/, "").split('_');
          return {
            no: parts[1] || "0",
            name: parts.slice(2).join(' '),
            imagePath: `${rawBase}/${f.name}`
          };
        })
        .sort((a, b) => parseInt(a.no) - parseInt(b.no));
      return { teamName: id, players };
    });
  } else {
    debugInfo = `API Error: ${files.message || "Unknown error"}. 探したパス: ${targetPath}`;
  }
} catch (e) {
  debugInfo = `System Error: ${e.message}`;
}

const teamColorMap = {
  CHA: 'bg-[#00788C]', PHI: 'bg-[#006BB6]', LAL: 'bg-[#552583]', GSW: 'bg-[#006BB6]',
  // ... 他のチームカラー ...
};
---

<Layout title="NBA CARDS">
  <div class="bg-[#1a1a1a] min-h-screen text-white p-6">
    
    {teamsData.length === 0 && (
      <div class="mb-8 p-4 bg-red-900/30 border border-red-500 rounded text-xs font-mono">
        <p class="font-bold text-red-400">【デバッグ情報：画像が見つかりません】</p>
        <p>現在のURLパラメータ: {queryFolder}</p>
        <p>GitHub上で探しているパス: <span class="bg-black px-1">{targetPath}</span></p>
        <p class="mt-2 text-gray-400">※GitHubの output/players/ 直下にこのフォルダがあるか確認してください。</p>
        <p>{debugInfo}</p>
      </div>
    )}

    {teamsData.length > 0 && (
      <div class="max-w-5xl mx-auto">
        <div class="flex justify-center items-center gap-8 mb-12 py-8 border-b border-white/10">
            {teamsData.map((t, i) => (
                <div class="text-center">
                    <div class="text-4xl font-black">{t.teamName}</div>
                    {i === 0 && <div class="text-blue-500 font-bold mt-2">VS</div>}
                </div>
            ))}
        </div>

        <div class="space-y-16">
          {teamsData.map((team) => (
            <section>
              <h2 class={`inline-block px-4 py-1 rounded text-sm font-bold mb-6 ${teamColorMap[team.teamName] || 'bg-gray-700'}`}>
                {team.teamName} PLAYERS
              </h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {team.players.map((p) => (
                  <div class="group cursor-pointer">
                    <div class="aspect-[3/4] rounded-lg overflow-hidden bg-black border border-white/5 group-hover:border-blue-500 transition-all">
                      <img src={p.imagePath} class="w-full h-full object-cover" />
                    </div>
                    <div class="mt-2 text-center text-xs font-medium opacity-70">#{p.no} {p.name}</div>
                  </div>
                ))}
              </div>
            </section>
          ))}
        </div>
      </div>
    )}
  </div>
</Layout>