---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const { searchParams } = Astro.url;
const queryFolder = searchParams.get('folder') || ""; 

const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const token = process.env.GITHUB_TOKEN;

// 1. 渡された値から「純粋なフォルダ名」だけを抽出
// "260126/NBA_Cards_ATL_0022500659" -> "NBA_Cards_ATL_0022500659"
const folderName = queryFolder.split('/').pop() || "";

// 2. 日付を特定（フォルダ名末尾の8桁。例: 20251202 -> 251202）
// フォルダ名に日付がない場合は、とりあえず本日の日付を予備にする
const dateMatch = folderName.match(/(\d{8})$/);
let dateId = dateMatch ? dateMatch[1].substring(2) : new Date().toISOString().slice(2,10).replace(/-/g,'');

// GitHub上のパスを再構築
let targetPath = `output/players/${dateId}/${folderName}`;
let rawBase = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${targetPath}`;

let teamsData = [];
let debugInfo = "";

try {
  // A. まずは推測した日付でトライ
  let apiURL = `https://api.github.com/repos/${GITHUB_REPO}/contents/${targetPath}?t=${Date.now()}`;
  let res = await fetch(apiURL, { headers: token ? { "Authorization": `token ${token}` } : {} });
  let files = await res.json();

  // B. もし失敗したら、日付なし（または別の日付）の可能性を考えて、全日付フォルダをスキャンする
  if (res.status === 404) {
    debugInfo += `Path [${targetPath}] not found. Searching other dates... `;
    const rootApi = `https://api.github.com/repos/${GITHUB_REPO}/contents/output/players`;
    const rootRes = await fetch(rootApi, { headers: token ? { "Authorization": `token ${token}` } : {} });
    const dateFolders = await rootRes.json();

    if (Array.isArray(dateFolders)) {
      for (const df of dateFolders) {
        const checkPath = `output/players/${df.name}/${folderName}`;
        const checkRes = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${checkPath}`, {
          headers: token ? { "Authorization": `token ${token}` } : {}
        });
        if (checkRes.ok) {
          const foundFiles = await checkRes.json();
          targetPath = checkPath;
          rawBase = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${targetPath}`;
          files = foundFiles;
          break;
        }
      }
    }
  }

  if (Array.isArray(files)) {
    const playerFiles = files.filter(f => f.name.toLowerCase().endsWith('.png'));
    const teamIds = [...new Set(playerFiles.map(f => f.name.split('_')[0]))];

    teamsData = teamIds.map(id => {
      const players = playerFiles
        .filter(f => f.name.startsWith(id + '_'))
        .map(f => {
          const parts = f.name.replace(/\.[^/.]+$/, "").split('_');
          return {
            no: parts[1] || "0",
            name: parts.slice(2).join(' '),
            imagePath: `${rawBase}/${f.name}`
          };
        })
        .sort((a, b) => parseInt(a.no) - parseInt(b.no));
      return { teamName: id, players };
    });
  }
} catch (e) {
  debugInfo = `System Error: ${e.message}`;
}

const teamColorMap = {
  CHA: 'bg-[#00788C]', PHI: 'bg-[#006BB6]', ATL: 'bg-[#E03A3E]', 
  LAL: 'bg-[#552583]', GSW: 'bg-[#006BB6]', WAS: 'bg-[#002B5C]'
};
---

<Layout title="NBA CARDS">
  <div class="bg-[#1a1a1a] min-h-screen text-white p-6 font-sans">
    
    {teamsData.length === 0 ? (
      <div class="max-w-xl mx-auto mt-20 text-center">
        <div class="animate-pulse mb-4 text-blue-500">Searching GitHub Repository...</div>
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl text-[10px] font-mono text-left opacity-60">
           <p>Last Try Path: {targetPath}</p>
           <p>{debugInfo}</p>
        </div>
      </div>
    ) : (
      <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-12 py-6 border-b border-white/10">
          <div class="text-2xl font-black italic">{teamsData[0]?.teamName} <span class="text-blue-500 not-italic text-sm mx-2">VS</span> {teamsData[1]?.teamName}</div>
          <button onclick="history.back()" class="text-xs bg-white/10 px-4 py-2 rounded-full uppercase font-bold hover:bg-white/20">Back</button>
        </header>

        <div class="space-y-20">
          {teamsData.map((team) => (
            <section>
              <div class={`inline-flex items-center gap-3 px-5 py-2 rounded-full mb-8 shadow-lg ${teamColorMap[team.teamName] || 'bg-gray-800'}`}>
                <span class="text-lg font-black tracking-tighter">{team.teamName}</span>
                <span class="text-[10px] uppercase font-bold opacity-80">Roster</span>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                {team.players.map((p) => (
                  <div class="group">
                    <div class="relative aspect-[3/4] rounded-2xl overflow-hidden bg-gradient-to-b from-gray-800 to-black border border-white/5 group-hover:border-blue-500/50 transition-all shadow-xl">
                      <img src={p.imagePath} class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500" />
                      <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/40 to-transparent">
                         <div class="text-[10px] font-black text-blue-400">#{p.no}</div>
                         <div class="text-sm font-bold truncate uppercase tracking-tight">{p.name}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          ))}
        </div>
      </div>
    )}
  </div>
</Layout>

<style is:global>
  body { background-color: #1a1a1a; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
</style>