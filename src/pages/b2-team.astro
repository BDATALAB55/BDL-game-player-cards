---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const { searchParams } = Astro.url;
const teamId = searchParams.get('team') || 'AOMORI';

const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const RECURSIVE_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1&t=${Date.now()}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/reports/B2`;
const token = process.env.GITHUB_TOKEN;

// B2用cityNameMap
const cityNameMap = {
  "AOMORI": "AOMORI", "WAT'S": "AOMORI", "WATS": "AOMORI",
  "IWATE": "IWATE", "BIGBULLS": "IWATE",
  "YAMAGATA": "YAMAGATA", "WYVERNS": "YAMAGATA",
  "FUKUSHIMA": "FUKUSHIMA", "FIREBONDS": "FUKUSHIMA",
  "YOKOHAMAEX": "YOKOHAMA EX", "EXCELLENCE": "YOKOHAMA EX",
  "FUKUI": "FUKUI", "BLOWWINDS": "FUKUI",
  "SHINSHU": "SHINSHU", "BRAVEWARRIORS": "SHINSHU",
  "SHIZUOKA": "SHIZUOKA", "VELTEX": "SHIZUOKA",
  "KOBE": "KOBE", "STORKZ": "KOBE",
  "NARA": "NARA", "BAMBITIOUS": "NARA",
  "EHIME": "EHIME", "ORANGEVIKINGS": "EHIME",
  "FUKUOKA": "FUKUOKA", "RIZING": "FUKUOKA",
  "KUMAMOTO": "KUMAMOTO", "VOLTERS": "KUMAMOTO",
  "KAGOSHIMA": "KAGOSHIMA", "REBNISE": "KAGOSHIMA"
};

// B2用teamInfo (カラーと検索キー)
const teamInfo = {
  AOMORI: { city: "Aomori", name: "Wat's", color: "#004194", searchKey: "WATS" },
  IWATE: { city: "Iwate", name: "Big Bulls", color: "#e22b30", searchKey: "BIGBULLS" },
  YAMAGATA: { city: "Yamagata", name: "Wyverns", color: "#53247a", searchKey: "WYVERNS" },
  FUKUSHIMA: { city: "Fukushima", name: "Firebonds", color: "#b44da1", searchKey: "FIREBONDS" },
  'YOKOHAMA EX': { city: "Yokohama", name: "Excellence", color: "#2a6c3d", searchKey: "EXCELLENCE" },
  FUKUI: { city: "Fukui", name: "Blowwinds", color: "#0d1a39", searchKey: "BLOWWINDS" },
  SHINSHU: { city: "Shinshu", name: "Brave Warriors", color: "#fff001", searchKey: "BRAVEWARRIORS" },
  SHIZUOKA: { city: "Shizuoka", name: "Veltex", color: "#21326a", searchKey: "VELTEX" },
  KOBE: { city: "Kobe", name: "Storkz", color: "#163f2e", searchKey: "STORKZ" },
  NARA: { city: "Nara", name: "Bambitious", color: "#8c2222", searchKey: "BAMBITIOUS" },
  EHIME: { city: "Ehime", name: "Orange Vikings", color: "#f79422", searchKey: "ORANGEVIKINGS" },
  FUKUOKA: { city: "Fukuoka", name: "Rizing", color: "#004098", searchKey: "RIZING" },
  KUMAMOTO: { city: "Kumamoto", name: "Volters", color: "#e62e2d", searchKey: "VOLTERS" },
  KAGOSHIMA: { city: "Kagoshima", name: "Rebnise", color: "#000000", searchKey: "REBNISE" },
};

const currentTeam = teamInfo[teamId] || { city: "B2.LEAGUE", name: "TEAM", color: "#FFFFFF", searchKey: "" };

// テキストサイズを反転させるチーム（B2向けに調整）
const reverseTeams = ['SHINSHU', 'EHIME', 'KAGOSHIMA'];
const isReversed = reverseTeams.includes(teamId);

let allTeamReports = [];
let availableDatesMap = {};

try {
  const res = await fetch(RECURSIVE_API, {
    headers: {
      ...(token ? { "Authorization": `token ${token}` } : {}),
      "Accept": "application/vnd.github.v3+json",
      "Cache-Control": "no-cache"
    }
  });
  const data = await res.json();

  if (data.tree) {
    const reportFiles = data.tree.filter(item => 
      item.path.includes('output/reports/B2/') && 
      item.path.endsWith('.png')
    );

    reportFiles.forEach(file => {
      const parts = file.path.split('/');
      const fileName = parts[parts.length - 1];
      const folderName = parts[parts.length - 2];
      
      if (currentTeam.searchKey && fileName.toUpperCase().includes(currentTeam.searchKey.toUpperCase())) {
        const nameParts = fileName.replace('.png', '').split('_');
        const fullDate = nameParts[0]; 
        const gameId = nameParts[1];
        const rawAway = nameParts[2] || "AWAY";
        const rawHome = nameParts[3] || "HOME";

        const displayAway = cityNameMap[rawAway.toUpperCase().replace(/[\s\-_]/g, '')] || rawAway;
        const displayHome = cityNameMap[rawHome.toUpperCase().replace(/[\s\-_]/g, '')] || rawHome;
        const targetCardFolder = `game_${gameId}_${rawAway}_${rawHome}_${fullDate}`;

        const reportObj = {
          id: folderName,
          date: `${fullDate.substring(0,4)}.${fullDate.substring(4,6)}.${fullDate.substring(6,8)}`,
          path: `${IMAGE_BASE_URL}/${folderName}/${fileName}?t=${Date.now()}`,
          fileName: fileName,
          away: displayAway,
          home: displayHome,
          link: `/b2-cards?folder=${folderName}/${targetCardFolder}`
        };
        allTeamReports.push(reportObj);
        if (!availableDatesMap[folderName]) availableDatesMap[folderName] = reportObj.link;
      }
    });
    allTeamReports.sort((a, b) => b.id.localeCompare(a.id));
  }
} catch (e) {
  console.error("Fetch failed:", e);
}
---

<Layout title={`${teamId} | B-Data Lab`}>
  <main class="bg-[#373A36] min-h-screen text-white font-avenir pb-80 overflow-x-hidden relative">
    
    <header class="pt-12 pb-6 px-6 max-w-6xl mx-auto w-full relative">
      <div class="flex items-end justify-between w-full relative mb-1 gap-4">
        
        <div class="flex-1 min-w-0">
          <div class="flex flex-col md:flex-row md:items-end md:gap-4 leading-tight md:leading-[0.8] font-bold font-avenir uppercase overflow-hidden">
            
            <span class={isReversed 
              ? "text-3xl sm:text-4xl md:text-7xl tracking-tighter shrink-0" 
              : "text-lg sm:text-xl md:text-3xl opacity-60 tracking-[0.2em] shrink-0"}>
              {currentTeam.city}
            </span>

            <span class={isReversed 
              ? "text-lg sm:text-xl md:text-3xl opacity-60 tracking-[0.2em] truncate" 
              : "text-3xl sm:text-4xl md:text-7xl tracking-tighter truncate"}>
              {currentTeam.name}
            </span>
          </div>
        </div>

        <div class="hidden md:flex flex-col items-end text-right space-y-3 mb-1 flex-shrink-0">
          <h2 class="text-3xl font-black tracking-widest uppercase leading-none">BDATALAB</h2>
          <div class="flex items-center gap-5">
            <a href="https://x.com/BDataLab5x5" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-1.5">
              <div class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors">
                <svg class="w-4 h-4 fill-white" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              </div>
              <span class="text-[10px] font-black tracking-widest uppercase text-white/40 group-hover:text-white transition-colors">X</span>
            </a>
            <div class="h-3 w-[1px] bg-white/20"></div>
            <a href="https://note.com/bdatalab5x5" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-1.5">
              <div class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-[#23bb9d] transition-colors">
                 <span class="text-[12px] font-black text-white">n</span>
              </div>
              <span class="text-[10px] font-black tracking-widest lowercase text-white/40 group-hover:text-white transition-colors">note</span>
            </a>
          </div>
        </div>
      </div>

      <div 
        class="absolute bottom-1 left-6 right-6 h-[3px] md:h-[5px]" 
        style={`background-color: ${currentTeam.color}; box-shadow: 0 4px 15px ${currentTeam.color}66;`}
      ></div>
    </header>

    <div class="max-w-6xl mx-auto px-6">
      <section class="mt-16">
        <div class="flex justify-between items-end mb-10">
          <div>
            <h2 class="text-3xl font-black uppercase tracking-tight italic">Game Reports</h2>
            <p class="text-white/40 text-[10px] font-bold tracking-widest uppercase mt-1">Click card to download</p>
          </div>
          <div class="text-right leading-none">
            <span class="text-7xl font-black italic opacity-20 block tracking-[-0.1em]">{allTeamReports.length}</span>
            <span class="text-[12px] font-bold opacity-40 uppercase tracking-[0.3em]">Games</span>
          </div>
        </div>

        {allTeamReports.length > 0 ? (
          <div class="flex overflow-x-auto gap-8 no-scrollbar snap-x pb-12">
            {allTeamReports.map(r => (
              <div class="flex-none w-[320px] snap-center">
                <div class="mb-4 flex items-center gap-2 px-2">
                  <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                  <span class="text-[14px] font-black tracking-wider text-white/80">{r.date}</span>
                </div>
                <a href={r.path} download={r.fileName} class="block cursor-pointer active:scale-95 transition-transform">
                  <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 aspect-[3/4.2] relative group">
                     <img src={r.path} alt="Report" class="w-full h-full object-cover" />
                     <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <span class="bg-black/60 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/20">Download PNG</span>
                     </div>
                  </div>
                </a>
                <div class="mt-6 flex justify-center">
                  <a href={r.link} class="inline-flex items-center gap-3 px-6 py-2.5 rounded-full bg-black/40 border-2 border-transparent bg-clip-padding relative hover:scale-110 transition-transform group">
                    <div class="absolute inset-0 p-[2px] rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-red-500 -z-10"></div>
                    <span class="text-[12px] font-black tracking-[0.2em] uppercase text-white">
                      {r.away} <span class="text-[9px] font-medium lowercase mx-1 text-white/50 italic px-1">vs</span> {r.home}
                    </span>
                  </a>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="py-20 text-center border-2 border-dashed border-white/5 rounded-3xl">
            <p class="text-white/20 font-black uppercase tracking-widest italic">No game reports found</p>
          </div>
        )}

        <section class="mt-24">
          <div class="max-w-md mx-auto">
            <h3 class="text-center text-[10px] font-black tracking-[0.4em] uppercase mb-8 text-white/30 italic">Game Calendar</h3>
            <div id="calendar" class="bg-black/30 p-8 rounded-[40px] border border-white/5 shadow-inner"></div>
          </div>
        </section>
      </section>
    </div>

    <div class="md:hidden flex flex-col items-center justify-center w-full py-20 gap-4">
      <h2 class="text-4xl font-black tracking-[0.2em] uppercase leading-none opacity-80">BDATALAB</h2>
      <div class="flex items-center gap-8">
        <a href="https://x.com/BDataLab5x5" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center gap-2">
          <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center active:bg-white/20 transition-colors border border-white/5">
            <svg class="w-6 h-6 fill-white" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          </div>
          <span class="text-[11px] font-black tracking-widest uppercase text-white/40">X</span>
        </a>
        <div class="h-6 w-[1px] bg-white/10"></div>
        <a href="https://note.com/bdatalab5x5" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center gap-2">
          <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center active:bg-[#23bb9d] transition-colors border border-white/5">
             <span class="text-[16px] font-black text-white">n</span>
          </div>
          <span class="text-[11px] font-black tracking-widest uppercase text-white/40">note</span>
        </a>
      </div>
    </div>

    <div class="fixed bottom-8 left-8 z-40">
        <button onclick="history.back()" class="bg-white/10 backdrop-blur-md text-white px-6 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl active:scale-95 border border-white/10">← Back</button>
    </div>
    <div class="fixed bottom-8 right-8 z-40">
      <a href="/b2-home" class="bg-gray-800 text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl active:scale-95 border border-white/10">B2 Home</a>
    </div>

  </main>
</Layout>

<script is:inline define:vars={{ availableDatesMap }}>
  let currentY = 2026;
  let currentM = 0;
  const dates = Object.keys(availableDatesMap).sort((a,b) => b.localeCompare(a));
  if (dates.length > 0) {
    currentY = 2000 + parseInt(dates[0].substring(0,2));
    currentM = parseInt(dates[0].substring(2,4)) - 1;
  }
  window.changeMonth = function(delta) {
    currentM += delta;
    if (currentM < 0) { currentM = 11; currentY--; }
    else if (currentM > 11) { currentM = 0; currentY++; }
    renderCalendar(currentY, currentM);
  };
  function renderCalendar(y, m) {
    const calendarEl = document.getElementById('calendar');
    const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
    const firstDay = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    let html = `
      <div class="flex justify-between items-center mb-10 px-2">
        <button onclick="changeMonth(-1)" class="text-white/30 hover:text-white transition-colors text-lg">←</button>
        <div class="font-black text-[13px] tracking-[0.3em] uppercase">${monthNames[m]} ${y}</div>
        <button onclick="changeMonth(1)" class="text-white/30 hover:text-white transition-colors text-lg">→</button>
      </div>
      <div class="grid grid-cols-7 gap-1 text-center text-[9px] font-black text-white/10 mb-6 tracking-widest">
        <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
      </div>
      <div class="grid grid-cols-7 gap-y-4 gap-x-2">`;
    for (let i = 0; i < firstDay; i++) html += `<div></div>`;
    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${String(y).substring(2)}${String(m + 1).padStart(2, '0')}${String(d).padStart(2, '0')}`;
      const link = availableDatesMap[dateStr];
      html += `
        <div class="flex items-center justify-center">
          ${link ? 
            `<a href="${link}" class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-600 text-white text-[12px] font-black shadow-[0_0_20px_rgba(37,99,235,0.4)] transition-all border border-white/20">${d}</a>` : 
            `<span class="text-white/10 text-[12px] font-bold">${d}</span>`
          }
        </div>`;
    }
    calendarEl.innerHTML = html + `</div>`;
  }
  renderCalendar(currentY, currentM);
</script>

<style is:global>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .font-avenir { font-family: 'Avenir Next', 'Avenir', 'Helvetica Neue', Arial, sans-serif; }
</style>