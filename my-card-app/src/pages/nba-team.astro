---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

// --- 設定値 ---
const { searchParams } = Astro.url;
const teamId = searchParams.get('team') || 'LAL';

const GITHUB_REPO = "BDATALAB55/BDL-game-player-cards";
const RECURSIVE_API = `https://api.github.com/repos/${GITHUB_REPO}/git/trees/main?recursive=1&t=${Date.now()}`;
const IMAGE_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/output/reports/NBA`;
const token = process.env.GITHUB_TOKEN;

const teamInfo = {
  ATL: { city: "Atlanta", name: "Hawks" }, BOS: { city: "Boston", name: "Celtics" },
  BKN: { city: "Brooklyn", name: "Nets" }, CHA: { city: "Charlotte", name: "Hornets" },
  CHI: { city: "Chicago", name: "Bulls" }, CLE: { city: "Cleveland", name: "Cavaliers" },
  DAL: { city: "Dallas", name: "Mavericks" }, DEN: { city: "Denver", name: "Nuggets" },
  DET: { city: "Detroit", name: "Pistons" }, GSW: { city: "Golden State", name: "Warriors" },
  HOU: { city: "Houston", name: "Rockets" }, IND: { city: "Indiana", name: "Pacers" },
  LAC: { city: "LA", name: "Clippers" }, LAL: { city: "Los Angeles", name: "Lakers" },
  MEM: { city: "Memphis", name: "Grizzlies" }, MIA: { city: "Miami", name: "Heat" },
  MIL: { city: "Milwaukee", name: "Bucks" }, MIN: { city: "Minnesota", name: "Timberwolves" },
  NOP: { city: "New Orleans", name: "Pelicans" }, NYK: { city: "New York", name: "Knicks" },
  OKC: { city: "Oklahoma City", name: "Thunder" }, ORL: { city: "Orlando", name: "Magic" },
  PHI: { city: "Philadelphia", name: "76ers" }, PHX: { city: "Phoenix", name: "Suns" },
  POR: { city: "Portland", name: "Trail Blazers" }, SAC: { city: "Sacramento", name: "Kings" },
  SAS: { city: "San Antonio", name: "Spurs" }, TOR: { city: "Toronto", name: "Raptors" },
  UTA: { city: "Utah", name: "Jazz" }, WAS: { city: "Washington", name: "Wizards" },
};

const currentTeam = teamInfo[teamId] || { city: "NBA", name: "TEAM" };

let allTeamGroups = []; // 全てのチーム試合データをグループ化して保持
let availableDates = []; // そのチームの試合がある日付リスト

try {
  const res = await fetch(RECURSIVE_API, {
    headers: token ? { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" } : { "Accept": "application/vnd.github.v3+json" }
  });
  const data = await res.json();

  if (data.tree) {
    const allFiles = data.tree.filter(item => item.path.includes('output/reports/NBA/') && item.path.toLowerCase().endsWith('.png'));
    const groups = {};

    allFiles.forEach(file => {
      const pathParts = file.path.split('/');
      const folderName = pathParts[pathParts.indexOf('NBA') + 1];
      const fileName = pathParts[pathParts.indexOf('NBA') + 2];
      const nameParts = fileName.replace('.png', '').split('_');
      
      const gameId = nameParts[2];
      const fullDate = nameParts[1];
      const teamA = nameParts[nameParts.length - 2];
      const teamB = nameParts[nameParts.length - 1];

      // 指定チームが含まれる場合のみ
      if (teamA === teamId || teamB === teamId) {
        if (!groups[folderName]) {
          groups[folderName] = {
            id: folderName,
            date: `20${folderName.substring(0,2)}.${folderName.substring(2,4)}.${folderName.substring(4,6)}`,
            reports: []
          };
        }
        groups[folderName].reports.push({
          path: `${IMAGE_BASE_URL}/${folderName}/${fileName}`,
          fileName: fileName,
          away: teamA,
          home: teamB,
          link: `/nba-cards?folder=${folderName}/NBA_Cards_${gameId}_${fullDate}`
        });
      }
    });
    allTeamGroups = Object.values(groups).sort((a, b) => b.id.localeCompare(a.id));
    availableDates = allTeamGroups.map(g => g.id);
  }
} catch (e) {
  console.error(e);
}
---

<Layout title={`${teamId} | B-Data Lab`}>
  <main class="bg-[#373A36] min-h-screen text-white font-avenir pb-40 overflow-x-hidden relative">
    
    <header class="pt-20 pb-12 text-center px-6 relative">
      <div class="absolute top-10 left-1/2 -translate-x-1/2 text-[120px] font-black opacity-5 select-none italic uppercase tracking-tighter w-full leading-none">{currentTeam.name}</div>
      <div class="relative z-10">
        <p class="text-blue-500 font-black tracking-[0.5em] uppercase text-sm mb-2 italic">{currentTeam.city}</p>
        <h1 class="text-7xl md:text-8xl font-black tracking-tighter italic uppercase leading-tight">{currentTeam.name}</h1>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-6">
      
      <section class="mt-16">
        <div class="flex flex-col gap-1 mb-10">
          <span id="display-label" class="text-blue-500 text-[10px] font-black uppercase tracking-[0.3em]">Latest Report</span>
          <span id="display-date" class="text-white text-[32px] font-bold uppercase leading-none tracking-[0.05em]">
            {allTeamGroups.length > 0 ? allTeamGroups[0].date : "NO DATA"}
          </span>
        </div>

        <div id="report-slider" class="flex overflow-x-auto gap-8 no-scrollbar snap-x pb-12">
          {allTeamGroups.length > 0 ? allTeamGroups[0].reports.map(r => (
            <div class="flex-none w-[320px] snap-center">
              <a href={r.path} download={r.fileName} class="block active:scale-95 transition-transform">
                <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 aspect-[3/4.2] group relative">
                   <img src={r.path} class="w-full h-full object-cover" />
                   <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                      <span class="bg-black/60 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/20">Download PNG</span>
                   </div>
                </div>
              </a>
              <div class="mt-6 flex justify-center">
                <a href={r.link} class="inline-flex items-center gap-3 px-6 py-2.5 rounded-full bg-black/40 border-2 border-transparent bg-clip-padding relative group overflow-hidden">
                  <div class="absolute inset-0 p-[2px] rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-red-500 -z-10"></div>
                  <span class="text-[12px] font-black tracking-[0.2em] uppercase text-white">{r.away} <span class="mx-1 text-white/50 italic px-1">vs</span> {r.home}</span>
                </a>
              </div>
            </div>
          )) : <div class="w-full py-20 text-center opacity-20 font-black uppercase tracking-widest">No matching games found</div>}
        </div>
      </section>

      <section class="mt-20">
        <div class="max-w-md mx-auto">
          <h3 class="text-center text-[10px] font-black tracking-[0.3em] uppercase mb-6 text-white/40 italic">Game Calendar</h3>
          <div id="calendar" class="bg-black/20 p-8 rounded-[40px] border border-white/5 shadow-2xl"></div>
        </div>
      </section>

    </div>

    <div class="fixed bottom-8 left-8 z-40">
      <button onclick="history.back()" class="bg-white/10 backdrop-blur-md text-white px-6 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl hover:bg-white/20 transition-all border border-white/10">← Back</button>
    </div>
    <div class="fixed bottom-8 right-8 z-40">
      <a href="/nba" class="bg-gray-800 text-white px-8 py-4 rounded-full font-black text-[11px] uppercase tracking-widest shadow-2xl active:scale-95 hover:scale-105 transition-all border border-white/10">NBA Home</a>
    </div>

  </main>
</Layout>

<script is:inline define:vars={{ allTeamGroups, availableDates }}>
  let currentY = 2026;
  let currentM = 0;

  if (availableDates.length > 0) {
    const latest = availableDates[0];
    currentY = 2000 + parseInt(latest.substring(0,2));
    currentM = parseInt(latest.substring(2,4)) - 1;
  }

  window.updateReports = function(dateId) {
    const sliderEl = document.getElementById('report-slider');
    const dateTitleEl = document.getElementById('display-date');
    const labelEl = document.getElementById('display-label');
    const data = allTeamGroups.find(g => g.id === dateId);
    if (!data || !sliderEl) return;

    dateTitleEl.innerText = data.date;
    labelEl.innerText = (dateId === availableDates[0]) ? "Latest Report" : "Archive Data";
    labelEl.className = `text-[10px] font-black uppercase tracking-[0.3em] ${dateId === availableDates[0] ? 'text-blue-500' : 'text-gray-500'}`;

    sliderEl.innerHTML = data.reports.map(r => `
      <div class="flex-none w-[320px] snap-center">
        <a href="${r.path}" download="${r.fileName}" class="block active:scale-95 transition-transform">
          <div class="rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black/40 aspect-[3/4.2] group relative">
             <img src="${r.path}" class="w-full h-full object-cover" />
             <div class="absolute inset-0 bg-black/40 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                <span class="bg-black/60 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/20">Download PNG</span>
             </div>
          </div>
        </a>
        <div class="mt-6 flex justify-center">
          <a href="${r.link}" class="inline-flex items-center gap-3 px-6 py-2.5 rounded-full bg-black/40 border-2 border-transparent bg-clip-padding relative">
            <div class="absolute inset-0 p-[2px] rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-red-500 -z-10"></div>
            <span class="text-[12px] font-black tracking-[0.2em] uppercase text-white">${r.away} <span class="mx-1 text-white/50 italic px-1">vs</span> ${r.home}</span>
          </a>
        </div>
      </div>
    `).join('');
    sliderEl.scrollTo({ left: 0, behavior: 'smooth' });
  };

  window.changeMonth = function(delta) {
    currentM += delta;
    if (currentM < 0) { currentM = 11; currentY--; }
    else if (currentM > 11) { currentM = 0; currentY++; }
    renderCalendar(currentY, currentM);
  };

  function renderCalendar(y, m) {
    const calendarEl = document.getElementById('calendar');
    const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
    const firstDay = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    
    let html = `
      <div class="flex justify-between items-center mb-8">
        <button onclick="changeMonth(-1)" class="text-white/40 hover:text-white transition-colors">←</button>
        <div class="font-black text-xs tracking-[0.2em] uppercase">${monthNames[m]} ${y}</div>
        <button onclick="changeMonth(1)" class="text-white/40 hover:text-white transition-colors">→</button>
      </div>
      <div class="grid grid-cols-7 gap-1 text-center text-[8px] font-black text-white/20 mb-4 tracking-tighter">
        <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
      </div>
      <div class="grid grid-cols-7 gap-2">`;

    for (let i = 0; i < firstDay; i++) html += `<div></div>`;
    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${String(y).substring(2)}${String(m + 1).padStart(2, '0')}${String(d).padStart(2, '0')}`;
      const hasGame = availableDates.includes(dateStr);
      html += `
        <div class="aspect-square flex items-center justify-center rounded-xl text-[11px] font-bold transition-all
          ${hasGame ? "bg-blue-600 text-white cursor-pointer shadow-lg shadow-blue-900/40 hover:scale-110 active:scale-90" : "text-white/10"}"
          ${hasGame ? `onclick="updateReports('${dateStr}')"` : ''}>${d}</div>`;
    }
    calendarEl.innerHTML = html + `</div>`;
  }
  renderCalendar(currentY, currentM);
</script>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>